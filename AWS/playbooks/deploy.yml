- name: Deploy CloudFormation stack and upload frontend (AWS flavor)
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ../vaults/prod.yml

  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_access_key_id }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key }}"
    AWS_DEFAULT_REGION: "{{ aws_region }}"

  tasks:
    - name: Deploy / update CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ cfn_stack }}"
        state: present
        region: "{{ aws_region }}"
        template: "{{ playbook_dir }}/../template.yaml"
        template_parameters:
          BucketName: "{{ bucket_name }}"

    - name: Build frontend flavor (aws)
      ansible.builtin.command: ./scripts/build-frontend.sh "{{ frontend_flavor }}"
      args:
        chdir: "{{ playbook_dir }}/../.."   # jumps from AWS/playbooks to repo root

    - name: Upload frontend to S3
      ansible.builtin.command: >
        aws s3 sync "frontend/dist/{{ frontend_flavor }}/" "s3://{{ bucket_name }}/" --delete
      args:
        chdir: "{{ playbook_dir }}/../.."   # run from repo root
